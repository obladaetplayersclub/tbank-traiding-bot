from detect_tickers import detect_tickers
from get_gpt_data import get_gpt_data
import unique_checker

def add_news(checker, news_list, ticker_lookup, ticker_list):
    '''news_list = [
        "Розничная сеть «Магнит» объявила о рекордном росте чистой прибыли за второй квартал 2025 года: показатель увеличился на 25 % по сравнению с аналогичным периодом прошлого года. Компания отмечает, что основными драйверами стали расширение ассортимента и оптимизация логистических цепочек. В отчёте подчёркивается, что выручка выросла до 450 млрд ₽, а операционная маржа достигла 8 %. Генеральный директор «Магнита» связал успех с запуском программы лояльности и усилением работы в онлайн-канале. Представители сети также отметили высокую активность покупателей в регионах присутствия.",
        "Розничная сеть «Магнит» объявила о рекордном росте чистой прибыли за второй квартал 2025 года: показатель увеличился на 25 % по сравнению с аналогичным периодом прошлого года. Компания отмечает, что основными драйверами стали расширение ассортимента и оптимизация логистических цепочек. В отчёте подчёркивается, что выручка выросла до 450 млрд ₽, а операционная маржа достигла 8 %. Генеральный директор «Магнита» связал успех с запуском программы лояльности и усилением работы в онлайн-канале. Представители сети также отметили высокую активность покупателей в регионах присутствия.",
        "В отчёте «Магнита» за второй квартал 2025 года зафиксировано снижение чистой прибыли на 10 % относительно аналогичного периода прошлого года. По словам финансового директора, сдерживающим фактором стали рост затрат на энергоносители и повышение арендных ставок. Выручка осталась практически на уровне 400 млрд ₽, но маржа упала до 6 %. Эксперты связывают ухудшение показателей с высокой конкуренцией со стороны дискаунтеров. В ряде регионов команда «Магнита» зафиксировала снижение покупательской активности.",
        "«Магнит» запустил новую линейку экологичной упаковки для свежих овощей и фруктов, использующей биоразлагаемые материалы. В пресс-релизе компании отмечается, что переход позволит снизить объём пластика на 2 000 тонн в год. Производство такой упаковки наладили на собственном заводе в Краснодарском крае. Розничная сеть также планирует постепенно перевести на био-упаковку все категории готовых блюд. По оценкам экосообщества, инициатива может стать моделью для других операторов рынка.",
        "Экологи обвинили «Магнит» в «зелёном камуфляже» после запуска новой биоразлагаемой упаковки. Активисты утверждают, что фактическая доля био-материалов в коробке составляет менее 30 %, а остальная часть остаётся обычным пластиком. По мнению критиков, компания использует модную тему эко для повышения лояльности без реальной экологической пользы. Представители «Магнита» заявляют, что сообщали о составе корректно, однако вызывают сомнения сроки и условия разложения. Некоторые эксперты полагают, что сеть рискует репутационными потерями.",
        "Розничная сеть «Магнит» подписала стратегическое соглашение с сервисом Yandex.Delivery о доставке продуктов в 50 городах России. Согласно договору, заказы на сумму свыше 1 500 ₽ будут доставляться бесплатно в течение трёх часов. Партнёры отмечают, что интеграция ИТ-платформ пройдёт в два этапа и будет завершена к концу лета. Компания подчёркивает, что новый сервис позволит увеличить онлайн-продажи на 30 %. Ожидается, что удобная схема доставки привлечёт дополнительную молодую аудиторию.",
        "«Магнит» и Яндекс.Доставка запустят совместный проект по экспресс-доставке продуктов из супермаркетов в 50 населённых пунктах. Клиенты смогут оформить заказ через мобильное приложение сети и получить его в течение трёх часов без комиссии при покупке от 1 500 ₽. В пресс-службе компаний отметили, что техническая интеграция будет завершена в два этапа до конца августа. Ожидается, что нововведение повысит долю e-commerce бизнеса «Магнита» на треть. Помимо этого, планируется тестировать ночные поставки для городов-милионников.",
        "В мае «Магнит» открыл 100 новых магазинов формата «у дома» в Московской области. На церемонии запуска присутствовали заместитель губернатора Подмосковья и руководители сети. Новые точки оборудованы современными кассовыми зонами и собственными пекарнями. Компания отметила, что расширение в регионе позволит обеспечить продуктовую доступность для 1,2 млн жителей. По словам операционного директора, все магазины настроены на скоростной ритм городской торговли. Запуск сопровождался масштабной рекламной кампанией.",
        "«Магнит» отложил открытие 100 запланированных магазинов в Московской области из-за задержек с поставками оборудования. Представители сети сообщили, что перебои с производителями холодильных витрин и касс замедлили монтаж инфраструктуры. Первоначальный запуск, намеченный на май, перенесён на третий квартал 2025 года. Операционный директор объяснил решение необходимостью обеспечить единый стандарт качества во всех точках. По предварительным оценкам, перенос может снизить рост выручки сети в регионе на 5 %.",
        "«Магнит» завершил покупку региональной сети продуктовых магазинов «Лавка» за 3 млрд ₽. В результате сделки компания получит доступ к 75 точкам розницы в Южном федеральном округе. По словам директора по M&A, синергия позволит сократить логистические затраты и оптимизировать ассортимент. Продавец сети поможет обеспечить плавную передачу бизнеса без потери клиентской базы. Эксперты ожидают, что объединённая сеть укрепит позиции «Магнита» в ключевых регионах.",
        "Аналитики предупреждают о рисках монополизации рынка после приобретения «Магнитом» сети «Лавка» за 3 млрд ₽. По их оценкам, объединение создаёт избыточную концентрацию в некоторых городах Южного федерального округа. Эксперты полагают, что это может привести к росту цен и снижению конкуренции. Представители «Магнита» отрицают подобные опасения, подчёркивая, что планируют сохранить текущие тарифы и расширить ассортимент. Тем не менее Федеральная антимонопольная служба пообещала внимательно отслеживать динамику цен после сделки. Некоторые потребители уже выразили обеспокоенность возможным ухудшением условий."

    ]'''
    dict_list = [
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит"],
            "compressed_message": "Розничная сеть «Магнит» сообщила о росте чистой прибыли за II кв. 2025 г. на 25 % до 450 млрд ₽ при операционной марже 8 % благодаря расширению ассортимента, оптимизации логистики, запуску программы лояльности и развитию онлайн-канала.",
            "polarity": "positive",
            "intensity": 9
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит"],
            "compressed_message": "Розничная сеть «Магнит» сообщила о росте чистой прибыли за II кв. 2025 г. на 25 % до 450 млрд ₽ при операционной марже 8 % благодаря расширению ассортимента, оптимизации логистики, запуску программы лояльности и развитию онлайн-канала.",
            "polarity": "positive",
            "intensity": 9
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит"],
            "compressed_message": "В отчёте «Магнита» за II кв. 2025 г. зафиксировано снижение чистой прибыли на 10 % до примерно 360 млрд ₽ и падение маржи до 6 % из-за роста затрат на энергоносители и арендных ставок.",
            "polarity": "negative",
            "intensity": 2
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит"],
            "compressed_message": "«Магнит» запустил биоразлагаемую упаковку для овощей и фруктов, что позволит снизить объём пластика на 2 000 тонн в год; производство наладили на заводе в Краснодарском крае, планируется расширить на готовые блюда.",
            "polarity": "positive",
            "intensity": 8
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит"],
            "compressed_message": "Экологи обвинили «Магнит» в «зелёном камуфляже»: упаковка содержит менее 30 % био-материалов, остальное — пластик, что ставит под сомнение реальную экологическую пользу.",
            "polarity": "negative",
            "intensity": 3
        },
        {
            "tickers": ["MGNT", "YNDX"],
            "organizations": ["Магнит", "Yandex.Delivery"],
            "compressed_message": "«Магнит» и Yandex.Delivery подписали соглашение о бесплатной доставке заказов от 1 500 ₽ в 50 городах России за 3 ч; интеграция ИТ-платформ завершится к концу лета, ожидается рост онлайн-продаж на 30 %.",
            "polarity": "positive",
            "intensity": 8
        },
        {
            "tickers": ["MGNT", "YNDX"],
            "organizations": ["Магнит", "Яндекс.Доставка"],
            "compressed_message": "«Магнит» и Яндекс.Доставка запускают экспресс-доставку продуктов в 50 населённых пунктах: заказы от 1 500 ₽ доставляют в течение 3 ч без комиссии, техническая интеграция до конца августа, e-commerce может вырасти на треть.",
            "polarity": "positive",
            "intensity": 8
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит"],
            "compressed_message": "В мае «Магнит» открыл 100 новых магазинов формата «у дома» в Московской области с современными кассами и собственными пекарнями, обеспечив доступность для 1,2 млн жителей.",
            "polarity": "positive",
            "intensity": 8
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит"],
            "compressed_message": "Открытие 100 магазинов «Магнита» в Подмосковье отложено на III кв. 2025 г. из-за задержек с поставками холодильных витрин и касс; рост выручки в регионе может замедлиться на 5 %.",
            "polarity": "negative",
            "intensity": 3
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит", "Лавка"],
            "compressed_message": "«Магнит» завершил покупку региональной сети «Лавка» за 3 млрд ₽, получив 75 точек в Южном федеральном округе; синергия сократит логистические затраты и оптимизирует ассортимент.",
            "polarity": "neutral",
            "intensity": 5
        },
        {
            "tickers": ["MGNT"],
            "organizations": ["Магнит", "Лавка", "Федеральная антимонопольная служба"],
            "compressed_message": "Аналитики предупреждают о рисках монополизации после покупки «Лавки» за 3 млрд ₽: концентрация в Южном округе может привести к росту цен; ФАС обещает мониторить ситуацию.",
            "polarity": "negative",
            "intensity": 2
        },
    ]




    #checker = unique_checker.NewsDeduplicator(ticker_list)

    #result = filter_unique(news_list, ticker_lookup, ticker_list)
    #for item in result:
        #print(item)

    # 4. Обработка каждой новости
    #for news in news_list:
    for js in dict_list:
        #print(f"=== Новость ===\n{news}")

        # 4.1. Базовая детекция тикеров
        #tickers = set(detect_tickers(news, ticker_lookup, ticker_list))

        # 4.2. Добыча доп. данных через GPT
        #data = get_gpt_data(news)
        data = js
        tickers = set()
        # data['tickers'] — фрагменты текста для доп. детекции
        for fragment in data.get('tickers', []):
            tickers.update(detect_tickers(fragment, ticker_lookup, ticker_list))
        # data['organizations'] — названия организаций для детекции
        for org in data.get('organizations', []):
            tickers.update(detect_tickers(org, ticker_lookup, ticker_list))

        # Выводим
        print(f"Найденные тикеры: {tickers}")
        print(f"Сжатое содержание: {data.get('compressed_message')}")
        polarity = data.get('polarity')
        intensity = int(data.get('intensity'))
        print(f"Полярность: {polarity}")
        print(f"Интенсивность: {intensity}")

        text = data.get('compressed_message')

        # 4.3. Проверяем и добавляем, если уникальна
        print(data)
        if checker.add_news(text = text, tickers = tickers, polarity = polarity, intensity = intensity):
            print(f"[Добавлено]")
            #print(f"[Добавлено] '{text}' → {tickers}")
        else:
            print(f"[Дубликат]")
            #print(f"[Дубликат] '{text}' → {tickers}")
        print()

def print_news(checker):
    # 5. Вывод всех уникальных новостей
    print("\n=== Уникальные новости ===")
    for item in checker.get_unique():
        text = item['text']
        tickers = item['tickers']
        print(f"- '{text}' → {tickers}")
